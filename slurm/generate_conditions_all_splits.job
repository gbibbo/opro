#!/bin/bash
#SBATCH --job-name=gen_all_splits
#SBATCH --partition=3090
#SBATCH --gres=gpu:0
#SBATCH --cpus-per-task=4
#SBATCH --mem=16G
#SBATCH --time=04:00:00
#SBATCH --output=logs/gen_all_splits_%j.out
#SBATCH --error=logs/gen_all_splits_%j.err

# ==============================================================================
# Generate Conditions from ALL Data Splits (train + dev + test)
# ==============================================================================
#
# Creates a larger evaluation set combining all data splits.
# Expected: ~150+ base clips Ã— 27 conditions = ~4000+ samples
#
# Usage:
#   sbatch slurm/generate_conditions_all_splits.job
#
# ==============================================================================

set -e
set -u

echo "============================================"
echo "GENERATE CONDITIONS FROM ALL SPLITS"
echo "============================================"
echo "Job ID: $SLURM_JOB_ID"
echo "Node: $SLURM_NODELIST"
echo "Start time: $(date)"
echo "============================================"

mkdir -p logs

# Activate conda
source ~/miniconda3/etc/profile.d/conda.sh 2>/dev/null || source ~/.bashrc
conda activate opro || conda activate qwen_audio || { echo "ERROR: Could not activate conda"; exit 1; }
echo "Conda environment: $CONDA_DEFAULT_ENV"

# Check manifests
echo ""
echo "Checking available manifests..."
ls -la data/processed/base_1000ms/*.csv 2>/dev/null || echo "No manifests found"

# Run generation
echo ""
echo "Generating conditions from ALL splits..."
python scripts/generate_conditions_all_splits.py \
    --base_dir data/processed/base_1000ms \
    --output_dir data/processed/conditions_all_splits \
    --sr 16000

EXIT_CODE=$?

echo ""
echo "============================================"
echo "GENERATION COMPLETE"
echo "============================================"
echo "Exit code: $EXIT_CODE"
echo "End time: $(date)"

if [ $EXIT_CODE -eq 0 ]; then
    echo ""
    echo "Generated files:"
    ls -la data/processed/conditions_all_splits/
    echo ""
    echo "Manifest stats:"
    python -c "
import pandas as pd
df = pd.read_parquet('data/processed/conditions_all_splits/all_conditions_manifest.parquet')
print(f'Total samples: {len(df)}')
print(f'By split: {df[\"split\"].value_counts().to_dict()}')
print(f'By variant: {df[\"variant_type\"].value_counts().to_dict()}')
print(f'By label: {df[\"ground_truth\"].value_counts().to_dict()}')
"
fi

exit $EXIT_CODE
