#!/bin/bash
#SBATCH --job-name=gen_cond
#SBATCH --partition=3090
#SBATCH --gres=gpu:0
#SBATCH --cpus-per-task=4
#SBATCH --mem=16G
#SBATCH --time=01:00:00
#SBATCH --output=logs/gen_cond_%j.out
#SBATCH --error=logs/gen_cond_%j.err

# ==============================================================================
# Generate Band Filter and RIR Reverb Condition Variants
# ==============================================================================
#
# Creates band-filtered and reverberant versions of base 1000ms clips.
# No GPU needed - CPU-only audio processing.
#
# Usage:
#   sbatch slurm/generate_conditions.job
#
# ==============================================================================

set -e
set -u

echo "============================================"
echo "GENERATE CONDITION VARIANTS"
echo "============================================"
echo "Job ID: $SLURM_JOB_ID"
echo "Node: $SLURM_NODELIST"
echo "Start time: $(date)"
echo "============================================"

mkdir -p logs

# Activate conda
source ~/miniconda3/etc/profile.d/conda.sh 2>/dev/null || source ~/.bashrc
conda activate opro || conda activate qwen_audio || { echo "ERROR: Could not activate conda"; exit 1; }
echo "Conda environment: $CONDA_DEFAULT_ENV"

# Check for base clips
echo ""
echo "Checking for base clips..."

# Try different possible locations for base 1000ms clips
BASE_MANIFEST=""
for candidate in \
    "data/processed/base_1000ms/test_base.csv" \
    "data/processed/base_1000ms/dev_base.csv" \
    "data/processed/base_1000ms/train_base.csv" \
    "data/processed/clean_clips/clean_metadata.csv" \
    "data/processed/normalized_clips/normalized_metadata.csv"; do
    if [ -f "$candidate" ]; then
        BASE_MANIFEST="$candidate"
        echo "Found base manifest: $BASE_MANIFEST"
        break
    fi
done

if [ -z "$BASE_MANIFEST" ]; then
    echo "ERROR: No base manifest found!"
    echo "Tried:"
    echo "  - data/processed/base_1000ms/test_base.csv"
    echo "  - data/processed/base_1000ms/dev_base.csv"
    echo "  - data/processed/base_1000ms/train_base.csv"
    echo "  - data/processed/clean_clips/clean_metadata.csv"
    echo "  - data/processed/normalized_clips/normalized_metadata.csv"
    exit 1
fi

# Count available clips
echo ""
echo "Verifying audio files..."
python - "$BASE_MANIFEST" <<'PY'
import sys
import pandas as pd
from pathlib import Path

manifest_path = sys.argv[1]
if manifest_path.endswith('.csv'):
    df = pd.read_csv(manifest_path)
else:
    df = pd.read_parquet(manifest_path)

print(f"Manifest has {len(df)} entries")

# Check audio_path column
if "audio_path" not in df.columns:
    print("ERROR: No audio_path column in manifest")
    sys.exit(1)

# Count existing files
def resolve(p):
    p = Path(str(p))
    if p.is_file():
        return True
    if Path("data", p).is_file():
        return True
    return False

exists = df["audio_path"].apply(resolve)
print(f"Files found: {exists.mean():.1%} ({exists.sum()}/{len(df)})")

if exists.sum() < 10:
    print("ERROR: Not enough audio files found!")
    sys.exit(1)

print("OK - proceeding with generation")
PY

if [ $? -ne 0 ]; then
    echo "Audio verification failed!"
    exit 1
fi

# Run generation
echo ""
echo "Generating band filter and RIR variants..."
python scripts/generate_conditions.py \
    --input_manifest "$BASE_MANIFEST" \
    --output_dir data/processed/conditions_final \
    --sr 16000

EXIT_CODE=$?

echo ""
echo "============================================"
echo "GENERATION COMPLETE"
echo "============================================"
echo "Exit code: $EXIT_CODE"
echo "End time: $(date)"

if [ $EXIT_CODE -eq 0 ]; then
    echo ""
    echo "Generated files:"
    ls -la data/processed/conditions_final/
    echo ""
    echo "Band variants:"
    ls data/processed/conditions_final/band/ 2>/dev/null | wc -l
    echo ""
    echo "RIR variants:"
    ls data/processed/conditions_final/rir/ 2>/dev/null | wc -l
fi

exit $EXIT_CODE
